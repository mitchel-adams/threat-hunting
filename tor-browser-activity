
<img width="400" src="https://github.com/user-attachments/assets/44bac428-01bb-4fe9-9d85-96cba7698bee" alt="Tor Logo"/>

# Threat Hunting Report: Potential TOR Browser Activity
- [Scenario Reference](https://github.com/mitchel-adams)

## Platforms & Tooling
- Windows 10 VM (Azure)
- Microsoft Defender for Endpoint
- Kusto Query Language (KQL)
- TOR Browser

---

## Overview

Security teams observed suspicious encrypted network traffic possibly linked to TOR entry nodes. Anonymous feedback also indicated staff sharing ways to reach blocked web destinations.  
The objective of this investigation was to determine whether TOR was installed or used within the monitored environment and to report associated findings.

---

## TOR Hunting Strategy (High-Level)

- Query `DeviceFileEvents` for TOR‑related binaries.
- Query `DeviceProcessEvents` for install and execution.
- Query `DeviceNetworkEvents` for outbound traffic to TOR ports.

```kql
DeviceFileEvents | top 20 by Timestamp desc
```

```kql
DeviceNetworkEvents | top 20 by Timestamp desc
```

```kql
DeviceProcessEvents | top 20 by Timestamp desc
```

---

## Investigation Steps

### ✅ 1 — File Event Inspection
A user on endpoint **`vthreattor`** initiated activity involving multiple TOR‑named artifacts. A text file labeled `tor-shopping-list.txt` surfaced on the desktop shortly after the installer was present.

```kql
DeviceFileEvents
| where DeviceName == "vthreattor"
| where InitiatingProcessAccountName == "shabuwa"
| where FileName contains "tor"
| order by Timestamp desc
| project Timestamp, DeviceName, ActionType, FileName, FolderPath, SHA256, Account = InitiatingProcessAccountName
```

---

### ✅ 2 — Installation Execution
Event logs captured TOR installer execution from the Downloads directory using a silent flag around `2025‑01‑08T16:16:47Z`.

```kql
DeviceProcessEvents
| where DeviceName == "vthreattor"
| where ProcessCommandLine contains "tor-browser-windows-x86_64-portable-14.0.4.exe"
| project Timestamp, DeviceName, AccountName, FileName, FolderPath, SHA256, ProcessCommandLine, ActionType
```

---

### ✅ 3 — TOR Execution (Processes)
Process telemetry confirmed both `tor.exe` and `firefox.exe` were executed shortly after installation, confirming browser launch activity.

```kql
DeviceProcessEvents
| where DeviceName == "vthreattor"
| where FileName has_any ("tor.exe","firefox.exe","tor-browser.exe")
| project Timestamp, DeviceName, AccountName, ActionType, FileName, FolderPath, SHA256, ProcessCommandLine
| order by Timestamp desc
```

---

### ✅ 4 — Network Connections
Outbound connections initiated by `tor.exe` aligned with TOR network behavior. One session connected to `176.198.159.33:9001`, with additional encrypted traffic appearing over port 443 and local port 9150.

```kql
DeviceNetworkEvents
| where DeviceName == "vthreattor"
| where InitiatingProcessAccountName != "system"
| where InitiatingProcessFileName in ("tor.exe","firefox.exe")
| where RemotePort in ("9001","9030","9040","9050","9051","9150","80","443")
| project Timestamp, DeviceName, InitiatingProcessAccountName, ActionType, RemoteIP, RemotePort, RemoteUrl, InitiatingProcessFileName, InitiatingProcessFolderPath
| order by Timestamp desc
```

---

## Event Timeline

| Event | Time (UTC) | Description |
|-------|------------|-------------|
| Installer Download | 2025‑01‑08T14:14:48Z | TOR installer saved to Downloads |
| Installer Execution | 2025‑01‑08T14:16:47Z | TOR installer silently ran |
| TOR Launch | 2025‑01‑08T14:17:21Z | `tor.exe` + related processes initiated |
| First TOR Connection | 2025‑01‑08T14:18:01Z | Connection to `176.198.159.33` on port 9001 |
| Additional Connections | 2025‑01‑08T14:18:08Z+ | Additional encrypted sessions |
| File Creation | 2025‑01‑08T14:19Z | `tor-shopping-list.txt` created |

---

## Conclusion

The user downloaded, installed, and launched the TOR browser and engaged in TOR network activity. Observed behavior suggests intentional circumvention of standard monitoring controls.

---

## Response

- Host isolated through EDR.
- User’s manager notified.
- Follow‑up enforcement recommended.

---

## Supporting Queries
```kql
DeviceFileEvents
| where FileName startswith "tor"
```

```kql
DeviceProcessEvents
| where ProcessCommandLine contains "tor-browser"
```

```kql
DeviceFileEvents
| where FileName has_any ("tor.exe","firefox.exe")
```

```kql
DeviceProcessEvents
| where ProcessCommandLine has_any("tor.exe","firefox.exe")
```

```kql
DeviceNetworkEvents
| where InitiatingProcessFileName in~ ("tor.exe","firefox.exe")
| where RemotePort in (9001,9030,9040,9050,9051,9150)
| order by Timestamp desc
```

```kql
DeviceFileEvents
| where FileName contains "shopping-list"
```

---
